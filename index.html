<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=920, initial-scale=1.0" />
<title>–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Marck+Script&display=swap');

@font-face{
  font-family: "The Rum Is Gone";
  src: url("./TheRumIsGone-Wy1nG.ttf") format("truetype");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}

:root{
  --ink:#2a1c12;
  --paper:#efe0bf;
  --paper2:#e3d0a8;
  --edge:#3b2a1a;
  --floor:#f7edd3;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding: 14px 0;
  overflow-x:auto;
  background:
    radial-gradient(900px 500px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
    radial-gradient(700px 420px at 70% 75%, rgba(0,0,0,.08), transparent 60%),
    #cfc2a2;
  font-family:'Marck Script', cursive;
  color:var(--ink);
}

.sheet{
  width:920px;
  max-width:none;
  padding:38px;
  position:relative;
  background:
    radial-gradient(120px 90px at 20% 30%, rgba(0,0,0,.07), transparent 70%),
    radial-gradient(180px 120px at 70% 60%, rgba(0,0,0,.08), transparent 70%),
    radial-gradient(90px 70px at 80% 25%, rgba(0,0,0,.06), transparent 70%),
    linear-gradient(135deg, var(--paper), var(--paper2));
  border:none;
  border-radius:0;
  overflow:visible;
  box-shadow: 0 22px 60px rgba(0,0,0,.35), inset 0 0 70px rgba(0,0,0,.14);
  clip-path: polygon(
    2% 7%, 6% 3%, 12% 4%, 18% 2%, 26% 4%, 34% 2%, 42% 4%, 50% 2%, 58% 4%, 66% 2%, 74% 4%, 82% 2%, 90% 4%, 95% 3%, 98% 8%,
    98% 14%, 97% 20%, 99% 27%, 97% 34%, 99% 41%, 97% 49%, 99% 57%, 97% 65%, 99% 73%, 97% 81%, 98% 88%, 96% 94%,
    92% 97%, 86% 98%, 80% 96%, 74% 98%, 66% 96%, 58% 98%, 50% 96%, 42% 98%, 34% 96%, 26% 98%, 18% 96%, 10% 98%, 6% 96%, 3% 94%,
    2% 88%, 3% 82%, 1% 76%, 3% 68%, 1% 60%, 3% 52%, 1% 44%, 3% 36%, 1% 28%, 3% 20%, 2% 14%
  );
}
.sheet::before{
  content:"";
  position:absolute;
  inset:-16px;
  pointer-events:none;
  background:
    radial-gradient(115% 85% at 50% 45%, rgba(255,255,255,.16), rgba(255,255,255,0) 58%),
    radial-gradient(145% 120% at 50% 50%, rgba(0,0,0,.28), rgba(0,0,0,0) 64%),
    radial-gradient(130% 115% at 50% 50%, rgba(182,58,46,.20), rgba(182,58,46,0) 70%),
    radial-gradient(130% 115% at 50% 50%, rgba(229,154,58,.18), rgba(229,154,58,0) 74%);
  box-shadow:
    0 0 0 2px rgba(59,42,26,.58),
    0 0 0 8px rgba(59,42,26,.12);
  mix-blend-mode:multiply;
  opacity:.92;
  clip-path: inherit;
}
.sheet::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(18px 18px at 10% 10%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(22px 22px at 90% 12%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(22px 22px at 92% 90%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(20px 20px at 12% 92%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(300px 120px at 50% -10%, rgba(0,0,0,.13), transparent 60%),
    radial-gradient(320px 140px at 50% 110%, rgba(0,0,0,.13), transparent 60%),
    radial-gradient(120px 320px at -10% 50%, rgba(0,0,0,.11), transparent 65%),
    radial-gradient(120px 320px at 110% 50%, rgba(0,0,0,.11), transparent 65%),
    repeating-radial-gradient(circle at 22% 28%, rgba(0,0,0,.03) 0 1px, rgba(0,0,0,0) 1px 4px),
    repeating-radial-gradient(circle at 75% 68%, rgba(0,0,0,.025) 0 1px, rgba(0,0,0,0) 1px 5px);
  mix-blend-mode:multiply;
  opacity:.78;
  clip-path: inherit;
}

.title{
  text-align:center;
  font-size:54px;
  margin:0 0 22px;
  letter-spacing:.5px;
  text-shadow: 0 2px 0 rgba(255,255,255,.5);
  font-family: "The Rum Is Gone", "Marck Script", cursive;
}

.map{
  position:relative;
  height:520px;
  border: 3px solid rgba(59,42,26,.75);
  border-radius:14px;
  background:
    radial-gradient(900px 520px at 60% 40%, rgba(255,255,255,.28), transparent 60%),
    radial-gradient(200px 120px at 25% 70%, rgba(0,0,0,.05), transparent 70%),
    linear-gradient(135deg, #f8efd8, #f3e3bf);
  overflow:hidden;
  box-shadow: inset 0 0 22px rgba(0,0,0,.12);
}
.map:before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(60px 40px at 20% 25%, rgba(0,0,0,.06), transparent 70%),
    radial-gradient(90px 60px at 60% 55%, rgba(0,0,0,.05), transparent 70%),
    radial-gradient(70px 50px at 85% 70%, rgba(0,0,0,.05), transparent 70%);
  pointer-events:none;
  opacity:.75;
}

/* ===== –ö–æ–º–Ω–∞—Ç—ã ===== */
.rooms{ position:absolute; inset:14px; z-index:1; pointer-events:none; }
.room{
  position:absolute;
  border: 2px solid rgba(42,28,18,.55);
  border-radius:18px;
  background: linear-gradient(180deg, rgba(229,154,58,.06), rgba(182,58,46,.03));
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
  overflow:hidden;
}

/* ===== –ù–∞–∑–≤–∞–Ω–∏—è (–≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç, –Ω–µ –≤—ã–ª–µ–∑–∞—é—Ç) ===== */
.room-label{
  position:absolute;
  top: 7px;
  left: 10px;
  right: 10px;

  font-size: 20px;
  line-height: 1.05;
  color: rgba(42,28,18,.82);
  text-shadow: 0 1px 0 rgba(255,255,255,.65);
  font-style: italic;
  letter-spacing:.3px;

  pointer-events:none;
  -webkit-user-select:none;
  user-select:none;

  white-space: normal;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* —Å–ø–µ—Ü-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–µ–π */
.room-hall .room-label{
  top: auto;
  bottom: 10px;          /* –∫–æ—Ä–∏–¥–æ—Ä ‚Äî —Å–Ω–∏–∑—É */
  left: 10px;
  right: 10px;
  text-align: center;
  font-size: 17px;
}
.room-bath .room-label{
  font-size: 16px;       /* –≤–∞–Ω–Ω–∞—è ‚Äî –ø–æ–º–µ–ª—å—á–µ */
  line-height: 1.08;
}

/* ===== –î–≤–µ—Ä–∏ ===== */
.door{
  position:absolute;
  background: var(--floor);
  border-radius:8px;
  z-index:3;
  box-shadow:
    inset 0 0 0 1px rgba(42,28,18,.18),
    0 1px 0 rgba(255,255,255,.35);
}
.door::before,.door::after{
  content:"";
  position:absolute;
  background: rgba(42,28,18,.55);
  border-radius:2px;
  opacity:.8;
}
.door.v{ width:16px; height:44px; }
.door.v::before{ left:2px; top:4px; width:2px; height:36px; }
.door.v::after { right:2px; top:4px; width:2px; height:36px; }
.door.h{ width:44px; height:16px; }
.door.h::before{ top:2px; left:4px; width:36px; height:2px; }
.door.h::after { bottom:2px; left:4px; width:36px; height:2px; }

.room-bedroom{ top:0; left:0; width:45%; height:50%; }
.room-kitchen{ bottom:0; left:0; width:35%; height:50%; }
.room-toilet{ bottom:0; left:35%; width:10%; height:25%; }
.room-bath{ top:0; left:45%; width:10%; height:30%; border-radius:14px; }
.room-hall{ bottom:0; left:45%; width:10%; height:70%; border-radius:14px; }
.room-living{ top:0; right:0; width:45%; height:66%; }

/* ===== –ö–æ–º–ø–∞—Å ===== */
.compass{
  position:absolute;
  right:16px;
  bottom:16px;
  width:110px;
  height:110px;
  opacity:.85;
  z-index:2;
  filter: drop-shadow(0 3px 0 rgba(0,0,0,.15));
}
.compass svg{ width:100%; height:100%; }

/* ===== –ú–∞—Ä—à—Ä—É—Ç ===== */
.route{ position:absolute; inset:0; z-index:2; pointer-events:none; opacity:.95; }
.route path{
  stroke: rgba(42,28,18,.78);
  stroke-width: 4.6;
  fill:none;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 1 14;
  stroke-dashoffset: 0;
}

/* ===== –¢—É–º–∞–Ω –≤–æ–π–Ω—ã ===== */
.fog{
  position:absolute;
  left:0;
  top:0;
  width:100%;
  height:100%;
  z-index:5;
  pointer-events:none;
}
.fog .fog-dark{ fill: rgba(0,0,0,.96); }
.fog .fog-light{ fill: rgba(0,0,0,0); }
.fog .fog-current{
  fill: rgba(255,255,255,.03);
  stroke: rgba(255,255,255,.12);
  stroke-width: 2;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
}

/* ===== –ò–≥—Ä–æ–∫ ===== */
.player{
  position:absolute;
  z-index: 6;
  left: 0;
  top: 0;
  width: 44px;
  height: 44px;
  transform: translate(-50%,-50%) scale(.95);
  border: 3px solid rgba(42,28,18,.92);
  border-radius: 50%;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 55%),
    linear-gradient(135deg, rgba(239,224,191,.95), rgba(227,208,168,.95));
  box-shadow: 0 10px 16px rgba(0,0,0,.18), inset 0 0 18px rgba(0,0,0,.10);
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.player::before{ content:"‚ò†Ô∏è"; font-size: 20px; opacity: .9; transform: translateY(-1px); }
.player.moving{ filter: drop-shadow(0 6px 0 rgba(0,0,0,.10)); }
.player-hint{
  position:absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  padding: 2px 8px;
  border: 2px solid rgba(42,28,18,.75);
  border-radius: 999px;
  background: rgba(255,255,255,.55);
  box-shadow: 0 6px 12px rgba(0,0,0,.12);
  opacity: 0;
  transition: opacity .18s ease;
  white-space: nowrap;
}
.player.moving .player-hint{ opacity: .95; }

/* ===== –ö–∞–º–Ω–∏ ===== */
.gem{
  position:absolute;
  width:34px;
  height:34px;
  transform: rotate(45deg) scale(.75);
  border: 3px solid var(--ink);
  border-radius: 7px;
  box-shadow:
    inset 0 0 8px rgba(255,255,255,.55),
    0 6px 14px rgba(0,0,0,.20);
  z-index:4;
  opacity:0;
  pointer-events:none;
  transition: opacity .22s ease, transform .22s ease;
}
.gem.show{ opacity:1; transform: rotate(45deg) scale(1); pointer-events:auto; }
.gray   { background: linear-gradient(135deg, #bdbdbd, #8e8e8e); }
.white  { background: linear-gradient(135deg, #ffffff, #e8e8e8); }
.orange { background: linear-gradient(135deg, #f2b35c, #d4842a); }
.red    { background: linear-gradient(135deg, #d65a4a, #9f2c24); }
.gem::after{
  content:"";
  position:absolute; inset:-10px;
  background: radial-gradient(circle, rgba(255,255,255,.35), transparent 60%);
  transform: rotate(-45deg);
  opacity:.5;
}

/* ===== –°—É–Ω–¥—É–∫–∏ ===== */
.chest{
  position:absolute;
  width:46px;
  height:36px;
  z-index:4;
  border: 3px solid var(--ink);
  border-radius: 8px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.20), rgba(0,0,0,.06)),
    linear-gradient(135deg, #c28a3a, #8f5b1e);
  box-shadow: 0 10px 18px rgba(0,0,0,.18), inset 0 0 10px rgba(255,255,255,.20);
  transform: scale(.85);
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease, transform .25s ease;
}
.chest.show{ opacity: 1; transform: scale(1); pointer-events: auto; cursor: pointer; }
.chest::before{
  content:"";
  position:absolute;
  left:-3px; right:-3px;
  top:-3px;
  height:40%;
  border: 3px solid var(--ink);
  border-bottom: 0;
  border-radius: 10px 10px 8px 8px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.08)),
    linear-gradient(135deg, #d6a04a, #9a6522);
  transform-origin: 50% 100%;
  transition: transform .22s ease;
}
.chest::after{
  content:"";
  position:absolute;
  width:10px;
  height:12px;
  left:50%;
  top:50%;
  transform: translate(-50%,-35%);
  border: 2px solid rgba(42,28,18,.85);
  border-radius: 3px;
  background: linear-gradient(180deg, #f2d37a, #c79a38);
  box-shadow: inset 0 0 6px rgba(255,255,255,.25);
}
.chest.opened::before{ transform: rotateX(55deg) translateY(-2px); }

/* ===== –ü–æ–∑–∏—Ü–∏–∏ ===== */
#p1, #c1 { top: 360px; left: 420px; }
#p2, #c2 { top: 460px; left: 70px; }
#p3, #c3 { top: 20px; left: 400px; }
#p4, #c4 { top: 40px; left: 630px; }

/* ===== –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ===== */
.inventory{
  margin-top: 16px;
  padding: 14px 16px 12px;
  border: 2px solid rgba(42,28,18,.75);
  border-radius: 16px;
  background:
    radial-gradient(220px 90px at 25% 40%, rgba(255,255,255,.25), transparent 65%),
    radial-gradient(260px 110px at 75% 60%, rgba(0,0,0,.06), transparent 70%),
    linear-gradient(135deg, rgba(239,224,191,.85), rgba(227,208,168,.85));
  box-shadow: 0 12px 22px rgba(0,0,0,.16), inset 0 0 30px rgba(0,0,0,.08);
}
.inventory-title{
  font-size: 26px;
  text-align:center;
  margin-bottom: 10px;
  color: rgba(42,28,18,.9);
  text-shadow: 0 1px 0 rgba(255,255,255,.6);
}
.slots{ display:flex; gap: 12px; justify-content: space-between; }
.slot{
  flex:1;
  min-width: 0;
  height: 54px;
  border: 2px dashed rgba(42,28,18,.55);
  border-radius: 14px;
  position:relative;
  background: rgba(255,255,255,.18);
  box-shadow: inset 0 0 12px rgba(0,0,0,.10);
  overflow:hidden;
}
.slot-label{
  position:absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 16px;
  opacity:.75;
  white-space: nowrap;
}
.slot.filled{
  border-style: solid;
  border-color: rgba(42,28,18,.75);
  background: rgba(255,255,255,.22);
}
.slot .mini-gem{
  position:absolute;
  left: 50%;
  top: 14px;
  width: 22px;
  height: 22px;
  transform: translateX(-50%) rotate(45deg);
  border: 2px solid rgba(42,28,18,.9);
  border-radius: 5px;
  box-shadow: inset 0 0 6px rgba(255,255,255,.55), 0 6px 10px rgba(0,0,0,.15);
}
.slot .mini-gem.gray   { background: linear-gradient(135deg, #bdbdbd, #8e8e8e); }
.slot .mini-gem.white  { background: linear-gradient(135deg, #ffffff, #e8e8e8); }
.slot .mini-gem.orange { background: linear-gradient(135deg, #f2b35c, #d4842a); }
.slot .mini-gem.red    { background: linear-gradient(135deg, #d65a4a, #9f2c24); }

.inventory.pulse{ animation: invPulse .55s ease-in-out 0s 2; }
@keyframes invPulse{
  0%{ transform: translateX(0); }
  20%{ transform: translateX(-3px); }
  40%{ transform: translateX(3px); }
  60%{ transform: translateX(-2px); }
  80%{ transform: translateX(2px); }
  100%{ transform: translateX(0); }
}

.flying-gem{
  position: fixed;
  z-index: 99999;
  width: 34px;
  height: 34px;
  transform: rotate(45deg);
  border: 3px solid rgba(42,28,18,.95);
  border-radius: 7px;
  box-shadow: inset 0 0 8px rgba(255,255,255,.55), 0 10px 18px rgba(0,0,0,.22);
  pointer-events:none;
  left: 0; top: 0;
  transition:
    left .65s cubic-bezier(.2,.9,.2,1),
    top .65s cubic-bezier(.2,.9,.2,1),
    transform .65s cubic-bezier(.2,.9,.2,1),
    opacity .2s ease;
}

/* –ø–æ–¥—Å–∫–∞–∑–∫–∞ */
.clue{
  margin-top: 22px;
  font-size: 28px;
  border-top: 2px solid rgba(42,28,18,.75);
  padding-top: 18px;
  color: var(--ink);
}

button{
  margin-top: 18px;
  padding: 12px 20px;
  font-family: inherit;
  font-size: 24px;
  background: rgba(255,255,255,.25);
  border: 2px solid rgba(42,28,18,.85);
  border-radius: 14px;
  cursor:pointer;
  box-shadow: 0 8px 16px rgba(0,0,0,.15);
  transition: transform .08s ease, box-shadow .12s ease, opacity .12s ease;
}
button:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.18); }
button:active{ transform: translateY(0px); box-shadow: 0 6px 12px rgba(0,0,0,.16); }

/* ===== –ü–∞–ø–∏—Ä—É—Å ===== */
.papyrus-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 18px;
}
.papyrus-overlay.show{ display:flex; }
.papyrus{
  position: relative;
  width: min(520px, 92vw);
  padding: 30px 34px;
  background: linear-gradient(135deg, var(--paper), var(--paper2));
  border: 2px solid rgba(59,42,26,.7);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.35), inset 0 0 70px rgba(0,0,0,.12);
  text-align: center;
  color: var(--ink);
  transform: translateY(12px) scale(.98);
  opacity: 0;
  transition: transform .22s ease, opacity .22s ease;
}
.papyrus-overlay.show .papyrus{ transform: translateY(0) scale(1); opacity: 1; }
.papyrus::before,
.papyrus::after{
  content:"";
  position:absolute;
  top: 50%;
  width: 38px;
  height: 76%;
  transform: translateY(-50%);
  background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(0,0,0,.08));
  border: 2px solid rgba(59,42,26,.55);
  border-radius: 20px;
  box-shadow: inset 0 0 18px rgba(0,0,0,.12);
}
.papyrus::before{ left: -20px; }
.papyrus::after { right: -20px; }
.papyrus-text{ font-size: 40px; margin: 10px 0 14px; }
.papyrus-hint{ font-size: 20px; opacity: .8; margin: 0; }

/* ===== –ú–µ–±–µ–ª—å / –¥–µ–∫–æ—Ä ===== */
.room .furn{ position:absolute; pointer-events:none; }
.furn-shadow{ filter: drop-shadow(0 3px 0 rgba(0,0,0,.08)); opacity:.92; }

.furn-wood{
  background: linear-gradient(135deg, rgba(202,154,86,.85), rgba(132,86,34,.85));
  border: 2px solid rgba(42,28,18,.65);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.18);
}
.rug{
  border-radius: 18px;
  background:
    radial-gradient(120px 60px at 35% 40%, rgba(255,255,255,.25), transparent 65%),
    linear-gradient(135deg, rgba(229,154,58,.20), rgba(182,58,46,.08));
  border: 2px dashed rgba(42,28,18,.35);
  opacity:.85;
}

/* —Å–ø–∞–ª—å–Ω—è */
.bed{ border-radius: 18px; }
.bed::before{
  content:"";
  position:absolute; left:8%; top:10%;
  width:84%; height:32%;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(232,232,232,.55));
  border: 2px solid rgba(42,28,18,.35);
}
.bed::after{
  content:"";
  position:absolute; left:10%; bottom:10%;
  width:80%; height:46%;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(239,224,191,.55), rgba(227,208,168,.60));
  border: 2px solid rgba(42,28,18,.30);
}
.nightstand{ border-radius: 10px; }

/* –∫—É—Ö–Ω—è */
.counter{ border-radius: 14px; }
.counter::before{
  content:"";
  position:absolute; left:0; top:0;
  width:100%; height:30%;
  background: linear-gradient(135deg, rgba(255,255,255,.24), rgba(0,0,0,.08));
  border-bottom: 2px solid rgba(42,28,18,.35);
}
.sink{
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(245,245,245,.85), rgba(215,215,215,.85));
  border: 2px solid rgba(42,28,18,.45);
}
.sink::before{
  content:"";
  position:absolute; left:14%; top:18%;
  width:72%; height:64%;
  border-radius: 12px;
  background: rgba(0,0,0,.10);
  border: 2px solid rgba(42,28,18,.35);
}
.stove{
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(230,230,230,.85), rgba(185,185,185,.85));
  border: 2px solid rgba(42,28,18,.55);
}
.stove::before{
  content:"";
  position:absolute; inset:18% 12% 22% 12%;
  border-radius: 10px;
  border: 2px solid rgba(42,28,18,.40);
  background: rgba(0,0,0,.12);
}
.fridge{
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,.70), rgba(220,220,220,.70));
  border: 2px solid rgba(42,28,18,.45);
}
.fridge::before{
  content:"";
  position:absolute; left:8%; top:52%;
  width:84%; height:2px;
  background: rgba(42,28,18,.35);
}

/* –≥–æ—Å—Ç–∏–Ω–∞—è */
.sofa{
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(182,58,46,.16), rgba(239,224,191,.55));
  border: 2px solid rgba(42,28,18,.55);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.18);
}
.sofa::before{
  content:"";
  position:absolute; left:8%; top:10%;
  width:84%; height:32%;
  border-radius: 18px;
  background: rgba(255,255,255,.16);
  border: 2px solid rgba(42,28,18,.25);
}
.tv{
  border-radius: 10px;
  background: linear-gradient(135deg, rgba(40,40,40,.65), rgba(0,0,0,.35));
  border: 2px solid rgba(42,28,18,.55);
}
.tv::after{
  content:"";
  position:absolute; left:40%; bottom:-10%;
  width:20%; height:16%;
  border-radius: 8px;
  background: linear-gradient(135deg, rgba(202,154,86,.85), rgba(132,86,34,.85));
  border: 2px solid rgba(42,28,18,.55);
}
.table{ border-radius: 14px; }
.plant{
  border-radius: 10px;
  background: linear-gradient(135deg, rgba(116,167,106,.85), rgba(70,120,60,.85));
  border: 2px solid rgba(42,28,18,.55);
}
.plant::after{
  content:"";
  position:absolute; left:28%; bottom:-10%;
  width:44%; height:24%;
  border-radius: 0 0 10px 10px;
  background: linear-gradient(135deg, rgba(202,154,86,.9), rgba(132,86,34,.9));
  border: 2px solid rgba(42,28,18,.55);
}

/* –≤–∞–Ω–Ω–∞—è/—Ç—É–∞–ª–µ—Ç */
.bathtub{
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(255,255,255,.78), rgba(225,225,225,.78));
  border: 2px solid rgba(42,28,18,.40);
}
.bathtub::before{
  content:"";
  position:absolute; inset:16%;
  border-radius: 14px;
  background: rgba(0,0,0,.10);
  border: 2px solid rgba(42,28,18,.28);
}
.mirror{
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,.25), rgba(0,0,0,.05));
  border: 2px solid rgba(42,28,18,.35);
}
.toilet{
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(255,255,255,.80), rgba(215,215,215,.80));
  border: 2px solid rgba(42,28,18,.40);
}
.toilet::before{
  content:"";
  position:absolute; left:18%; top:10%;
  width:64%; height:34%;
  border-radius: 14px;
  background: rgba(0,0,0,.08);
  border: 2px solid rgba(42,28,18,.25);
}

/* –∫–æ—Ä–∏–¥–æ—Ä */
.console{ border-radius: 12px; }
.hanger{
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(202,154,86,.55), rgba(132,86,34,.55));
  border: 2px dashed rgba(42,28,18,.45);
}

/* ===== –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ ===== */
.confetti-layer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 100000;
}
.confetti{
  position:absolute;
  top:-12px;
  width: 10px;
  height: 16px;
  border-radius: 3px;
  opacity: .95;
  transform: translateY(0) rotate(0deg);
  animation: confettiFall 900ms ease-in forwards;
}
@keyframes confettiFall{
  0%   { transform: translateY(0) rotate(0deg); opacity: 0; }
  10%  { opacity: .95; }
  100% { transform: translateY(105vh) rotate(540deg); opacity: 0; }
}
</style>
</head>

<body>
  <div class="sheet">
    <div class="title">–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â</div>

    <div class="map" id="map">
      <div class="rooms">
        <!-- –°–ø–∞–ª—å–Ω—è -->
        <div class="room room-bedroom" id="room-bedroom">
          <div class="room-label">–¢–∞–π–Ω–∞ –°–Ω–æ–≤</div>
          <span class="door v" id="door-bedroom" style="right:-8px; bottom:18px;"></span>
          <div class="furn rug furn-shadow" style="left:5%; top:15%; width:40%; height:40%;"></div>
          <div class="furn bed furn-wood furn-shadow" style="left:5%; top:55%; width:40%; height:40%;"></div>
          <div class="furn nightstand furn-wood furn-shadow" style="right:15%; top:18%; width:14%; height:16%;"></div>
        </div>

        <!-- –ö—É—Ö–Ω—è -->
        <div class="room room-kitchen" id="room-kitchen">
          <div class="room-label">–ë—É—Ö—Ç–∞ –ü—Ä—è–Ω–æ—Å—Ç–µ–π</div>
          <span class="door v" id="door-kitchen" style="right:-8px; top:18px;"></span>
          <div class="furn rug furn-shadow" style="left:10%; top:58%; width:78%; height:32%;"></div>
          <div class="furn counter furn-wood furn-shadow" style="left:8%; top:10%; width:64%; height:22%;"></div>
          <div class="furn sink furn-shadow" style="left:10%; top:36%; width:28%; height:18%;"></div>
          <div class="furn stove furn-shadow" style="left:42%; top:36%; width:28%; height:18%;"></div>
          <div class="furn fridge furn-shadow" style="right:8%; top:12%; width:18%; height:44%;"></div>
        </div>

        <!-- –í–∞–Ω–Ω–∞—è -->
        <div class="room room-bath" id="room-bath">
          <div class="room-label">–û–∑–µ—Ä–æ –¢—É–º–∞–Ω–∞</div>
          <span class="door h" id="door-bath" style="left:50%; bottom:-8px; transform:translateX(-50%);"></span>
          <div class="furn mirror furn-shadow" style="left:16%; top:10%; width:68%; height:18%;"></div>
          <div class="furn bathtub furn-shadow" style="left:12%; top:36%; width:76%; height:52%;"></div>
        </div>

        <!-- –ö–æ—Ä–∏–¥–æ—Ä -->
        <div class="room room-hall" id="room-hall">
          <div class="room-label">–í—Ä–∞—Ç–∞</div>
          <div class="furn rug furn-shadow" style="left:18%; top:10%; width:64%; height:72%; border-radius:14px;"></div>
          <div class="furn console furn-wood furn-shadow" style="left:14%; top:18%; width:72%; height:12%;"></div>
          <div class="furn hanger furn-shadow" style="left:18%; bottom:12%; width:64%; height:16%;"></div>
        </div>

        <!-- –ì–æ—Å—Ç–∏–Ω–∞—è -->
        <div class="room room-living" id="room-living">
          <div class="room-label">–ó–∞–ª –û–±—ä—è—Ç–∏–π</div>
          <span class="door v" id="door-living" style="left:-8px; top:56%; transform:translateY(-50%);"></span>
          <div class="furn rug furn-shadow" style="left:14%; top:54%; width:72%; height:34%;"></div>
          <div class="furn sofa furn-shadow" style="left:14%; top:12%; width:52%; height:26%;"></div>
          <div class="furn table furn-wood furn-shadow" style="left:34%; top:42%; width:30%; height:12%;"></div>
          <div class="furn tv furn-shadow" style="right:10%; top:12%; width:22%; height:20%;"></div>
          <div class="furn plant furn-shadow" style="right:10%; bottom:10%; width:12%; height:16%;"></div>
        </div>

        <!-- –¢—É–∞–ª–µ—Ç -->
        <div class="room room-toilet" id="room-toilet">
          <div class="room-label">–¢—Ä–æ–Ω</div>
          <span class="door h" id="door-throne" style="left:50%; top:-8px; transform:translateX(-50%);"></span>
          <div class="furn mirror furn-shadow" style="left:18%; top:10%; width:64%; height:16%;"></div>
          <div class="furn toilet furn-shadow" style="left:14%; top:34%; width:72%; height:52%;"></div>
        </div>
      </div>

      <svg class="route" id="routeSvg" viewBox="0 0 900 520" preserveAspectRatio="none">
        <path id="routePath" d="M 0 0 L 0 0"></path>
      </svg>

      <!-- –¢–£–ú–ê–ù –í–û–ô–ù–´ -->
      <svg class="fog" id="fogSvg" viewBox="0 0 900 520" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <mask id="fogMaskDark">
            <rect x="0" y="0" width="900" height="520" fill="white"></rect>
            <g id="fogDarkHoles"></g>
          </mask>

          <mask id="fogMaskLight">
            <rect x="0" y="0" width="900" height="520" fill="black"></rect>
            <g id="fogLightAreas"></g>
          </mask>
        </defs>

        <rect class="fog-dark" x="0" y="0" width="900" height="520" mask="url(#fogMaskDark)"></rect>
        <rect class="fog-light" x="0" y="0" width="900" height="520" mask="url(#fogMaskLight)"></rect>

        <rect id="fogCurrentRect" class="fog-current" x="-999" y="-999" width="0" height="0" rx="18" ry="18"></rect>
      </svg>

      <div class="compass" aria-hidden="true">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="46" stroke="rgba(42,28,18,.65)" stroke-width="2.5" fill="rgba(255,255,255,.18)"/>
          <circle cx="50" cy="50" r="34" stroke="rgba(42,28,18,.35)" stroke-width="2" fill="transparent"/>
          <path d="M50 12 L58 50 L50 88 L42 50 Z" fill="rgba(182,58,46,.75)" stroke="rgba(42,28,18,.55)" stroke-width="2"/>
          <path d="M12 50 L50 42 L88 50 L50 58 Z" fill="rgba(229,154,58,.35)" stroke="rgba(42,28,18,.35)" stroke-width="2"/>
          <text x="50" y="20" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">N</text>
          <text x="50" y="94" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">S</text>
          <text x="8" y="54" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">W</text>
          <text x="92" y="54" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">E</text>
        </svg>
      </div>

      <!-- —Å—É–Ω–¥—É–∫–∏ -->
      <div class="chest" id="c1" title="–°—É–Ω–¥—É–∫ 1"></div>
      <div class="chest" id="c2" title="–°—É–Ω–¥—É–∫ 2"></div>
      <div class="chest" id="c3" title="–°—É–Ω–¥—É–∫ 3"></div>
      <div class="chest" id="c4" title="–°—É–Ω–¥—É–∫ 4"></div>

      <!-- –∫–∞–º–Ω–∏ -->
      <div class="gem gray" id="p1" title="–°–µ—Ä—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem white" id="p2" title="–ë–µ–ª—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem orange" id="p3" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem red" id="p4" title="–ö—Ä–∞—Å–Ω—ã–π –∫–∞–º–µ–Ω—å"></div>

      <!-- –∏–≥—Ä–æ–∫ -->
      <div class="player" id="player" aria-label="–ò–≥—Ä–æ–∫">
        <div class="player-hint" id="playerHint">–ò–¥—É‚Ä¶</div>
      </div>
    </div>

    <div class="inventory" id="inventory" aria-label="–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å">
      <div class="inventory-title">–î–æ–±—ã—á–∞ –∫–∞–ø–∏—Ç–∞–Ω–∞</div>
      <div class="slots">
        <div class="slot" id="slot-p1" data-title="–°–µ—Ä—ã–π —Ñ–µ–æ–Ω–∏—Ç"><span class="slot-label">–°–µ—Ä—ã–π</span></div>
        <div class="slot" id="slot-p2" data-title="–ë–µ–ª—ã–π –±—Ä–∏–ª–ª–∏–∞–Ω—Ç"><span class="slot-label">–ë–µ–ª—ã–π</span></div>
        <div class="slot" id="slot-p3" data-title="–û—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–æ–ø–∞–∑"><span class="slot-label">–û—Ä–∞–Ω–∂–µ–≤—ã–π</span></div>
        <div class="slot" id="slot-p4" data-title="–ö—Ä–∞—Å–Ω—ã–π —Ä—É–±–∏–Ω"><span class="slot-label">–ö—Ä–∞—Å–Ω—ã–π</span></div>
      </div>
    </div>

    <div class="clue" id="clue">–ù–∞–∂–º–∏ ¬´–°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ö–æ—Ç—É.</div>
    <button id="nextBtn" type="button" onclick="next()">–°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
  </div>

  <!-- –ø–∞–ø–∏—Ä—É—Å -->
  <div class="papyrus-overlay" id="papyrusOverlay" role="dialog" aria-modal="true" aria-label="–ü–∞–ø–∏—Ä—É—Å">
    <div class="papyrus" id="papyrusBox">
      <div class="papyrus-text">–≠—Ç–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –Ω–æ –≤—Å—ë –µ—â—ë —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏.</div>
      <p class="papyrus-hint">–õ—é–±–ª—é —Ç–µ–±—è, –º–∏–ª–∞—è, —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º üíñ</p>
    </div>
  </div>

<script>
/* ‚úÖ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
const clues = [
  "–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ, –∏—Å–∫–∞—Ç–µ–ª—å! –ü–µ—Ä–≤—ã–π —Å—É–Ω–¥—É–∫ –ø—Ä—è—á–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ –¥–æ–º —Ö—Ä–∞–Ω–∏—Ç –±–µ–ª—ã–µ –ø–∞—Ä—É—Å–∞ —á–∏—Å—Ç–æ—Ç—ã. –ó–∞–≥–ª—è–Ω–∏ –≤ —à–∫–∞—Ñ —Å –±–µ–ª—å—ë–º ‚Äî —Å–µ—Ä—ã–π —Ñ–µ–æ–Ω–∏—Ç –∂–¥—ë—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—É—Ç—å.",
  "–°–ª–µ–¥—É—é—â–∞—è –¥–æ–±—ã—á–∞ —Å—Ä–µ–¥–∏ –≤–∫—É—Å–Ω—ã—Ö —Ç—Ä–æ—Ñ–µ–µ–≤. –û—Ç–∫—Ä–æ–π –∫—É—Ö–æ–Ω–Ω—ã–π —à–∫–∞—Ñ —Å–æ —Å–Ω–µ–∫–∞–º–∏ ‚Äî —Ç–∞–º —Å—É–Ω–¥—É–∫, –∞ –≤ –Ω—ë–º –±–µ–ª—ã–π –±—Ä–∏–ª–ª–∏–∞–Ω—Ç, –∫–∞–∫ –∏—Å–∫—Ä–∞ –Ω–∞ –ª–∞–¥–æ–Ω–∏.",
  "–¢—Ä–µ—Ç–∏–π —Å–ª–µ–¥ –≤–µ–¥—ë—Ç –∫ –∞—Ä–æ–º–∞—Ç–∞–º –∏ –ø–µ–Ω–µ. –í —à–∫–∞—Ñ—É —Å –∫—Ä–µ–º–∞–º–∏ –∏ –º—ã–ª—å–Ω–æ-—Ä—ã–ª—å–Ω—ã–º–∏ –±–æ–≥–∞—Ç—Å—Ç–≤–∞–º–∏ —Å–ø—Ä—è—Ç–∞–Ω —Å—É–Ω–¥—É–∫ ‚Äî –¥–æ—Å—Ç–∞–Ω—å –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–æ–ø–∞–∑, –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–æ–ª–Ω—Ü–µ.",
  "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∞–¥ –±–ª–∏–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. –ò—â–∏ –Ω–∞ –¥–∏–≤–∞–Ω–µ: –ø–æ–¥ –ø–æ–¥—É—à–∫–æ–π —Å–ø—Ä—è—Ç–∞–Ω —Å—É–Ω–¥—É–∫, –∞ –≤ –Ω—ë–º –∫—Ä–∞—Å–Ω—ã–π —Ä—É–±–∏–Ω ‚Äî —Å–µ—Ä–¥—Ü–µ —ç—Ç–æ–≥–æ –¥–æ–º–∞.",
  "–≠—Ç–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –Ω–æ –≤—Å—ë –µ—â—ë —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏."
];

let i = -1;
let finalReady = false;
let started = false;

let routeDone = false;
const collected = new Set();

const stepLoot = [
  { chestId: "c1", gemId: "p1" },
  { chestId: "c2", gemId: "p2" },
  { chestId: "c3", gemId: "p3" },
  { chestId: "c4", gemId: "p4" },
];

/* ===== WebAudio: —à–∞–≥–∏ / —Å—É–Ω–¥—É–∫ / –¥–∑—ã–Ω—å ===== */
let audioCtx = null;
let audioReady = false;

function ensureAudio(){
  if(audioReady) return true;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return false;
  if(!audioCtx) audioCtx = new Ctx();
  if(audioCtx.state === "suspended"){
    audioCtx.resume().catch(()=>{});
  }
  audioReady = true;
  return true;
}

function makeMaster(){
  const g = audioCtx.createGain();
  g.gain.value = 0.22;
  g.connect(audioCtx.destination);
  return g;
}
let master = null;

function playFootstep(){
  if(!ensureAudio()) return;
  if(!master) master = makeMaster();

  const t = audioCtx.currentTime;

  const bufferSize = Math.floor(audioCtx.sampleRate * 0.06);
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let k=0;k<bufferSize;k++){
    data[k] = (Math.random()*2-1) * (1 - k/bufferSize);
  }
  const noise = audioCtx.createBufferSource();
  noise.buffer = buffer;

  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.setValueAtTime(520, t);

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.06, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);

  noise.connect(lp);
  lp.connect(g);
  g.connect(master);

  noise.start(t);
  noise.stop(t + 0.07);
}

function playChestOpen(){
  if(!ensureAudio()) return;
  if(!master) master = makeMaster();

  const t = audioCtx.currentTime;

  const bufferSize = Math.floor(audioCtx.sampleRate * 0.14);
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let k=0;k<bufferSize;k++){
    const fade = 1 - k/bufferSize;
    data[k] = (Math.random()*2-1) * fade;
  }
  const noise = audioCtx.createBufferSource();
  noise.buffer = buffer;

  const bp = audioCtx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(420, t);
  bp.Q.setValueAtTime(2.2, t);

  const gN = audioCtx.createGain();
  gN.gain.setValueAtTime(0.0001, t);
  gN.gain.exponentialRampToValueAtTime(0.10, t + 0.015);
  gN.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);

  noise.connect(bp);
  bp.connect(gN);
  gN.connect(master);

  const osc = audioCtx.createOscillator();
  osc.type = "triangle";
  osc.frequency.setValueAtTime(180, t);
  osc.frequency.exponentialRampToValueAtTime(120, t + 0.18);

  const gO = audioCtx.createGain();
  gO.gain.setValueAtTime(0.0001, t);
  gO.gain.exponentialRampToValueAtTime(0.06, t + 0.02);
  gO.gain.exponentialRampToValueAtTime(0.0001, t + 0.20);

  osc.connect(gO);
  gO.connect(master);

  noise.start(t);
  noise.stop(t + 0.18);
  osc.start(t);
  osc.stop(t + 0.22);
}

function playDing(){
  if(!ensureAudio()) return;
  if(!master) master = makeMaster();

  const t = audioCtx.currentTime;

  const osc1 = audioCtx.createOscillator();
  osc1.type = "sine";
  osc1.frequency.setValueAtTime(1480, t);

  const osc2 = audioCtx.createOscillator();
  osc2.type = "sine";
  osc2.frequency.setValueAtTime(990, t);

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.10, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.55);

  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(600, t);

  osc1.connect(hp);
  osc2.connect(hp);
  hp.connect(g);
  g.connect(master);

  osc1.start(t);
  osc2.start(t);
  osc1.stop(t + 0.6);
  osc2.stop(t + 0.6);
}

function bindAudioUnlock(){
  const unlock = () => {
    ensureAudio();
    window.removeEventListener("pointerdown", unlock);
    window.removeEventListener("keydown", unlock);
  };
  window.addEventListener("pointerdown", unlock, { once:true });
  window.addEventListener("keydown", unlock, { once:true });
}

/* ===== helpers ===== */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function centerInMapPx(el){
  const map = document.getElementById("map");
  const r = el.getBoundingClientRect();
  const m = map.getBoundingClientRect();
  return { x:(r.left-m.left)+r.width/2, y:(r.top-m.top)+r.height/2, w:r.width, h:r.height };
}
function rectInMapPx(el){
  const map = document.getElementById("map");
  const r = el.getBoundingClientRect();
  const m = map.getBoundingClientRect();
  return { left:r.left-m.left, top:r.top-m.top, width:r.width, height:r.height };
}
function getMapLocalPoint(clientX, clientY){
  const map = document.getElementById("map");
  const mr = map.getBoundingClientRect();
  return { x: clientX - mr.left, y: clientY - mr.top, w: mr.width, h: mr.height };
}
function rectContains(r, x, y){
  return x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
}

/* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è: –∫–æ–º–Ω–∞—Ç—ã + –¥–≤–µ—Ä–∏ ===== */
const NAV = { rooms:{}, doors:{}, adjacency:{}, kitchenPassage:null };

function captureNavGeometry(){
  const roomIds = ["room-bedroom","room-kitchen","room-bath","room-living","room-toilet","room-hall"];
  NAV.rooms = {};
  for(const id of roomIds){
    const el = document.getElementById(id);
    if(!el) continue;
    const r = rectInMapPx(el);
    NAV.rooms[id] = { left:r.left, top:r.top, right:r.left+r.width, bottom:r.top+r.height };
  }

  // ‚Äú–∫–∞—Ä–º–∞–Ω‚Äù –ø—Ä–æ—Ö–æ–¥–∞ –∫ –∫—É—Ö–Ω–µ (–Ω–∞–¥ —Ç—É–∞–ª–µ—Ç–æ–º)
  const k = NAV.rooms["room-kitchen"];
  const h = NAV.rooms["room-hall"];
  const t = NAV.rooms["room-toilet"];
  if(k && h && t){
    NAV.kitchenPassage = { left: k.right, right: h.left, top: k.top, bottom: t.top };
    if(NAV.kitchenPassage.right < NAV.kitchenPassage.left + 2 ||
       NAV.kitchenPassage.bottom < NAV.kitchenPassage.top + 2){
      NAV.kitchenPassage = null;
    }
  }else{
    NAV.kitchenPassage = null;
  }

  const doorDefs = [
    { id:"door-bedroom", a:"room-bedroom", b:"room-hall" },
    { id:"door-kitchen", a:"room-kitchen", b:"room-hall" },
    { id:"door-bath",    a:"room-bath",    b:"room-hall" },
    { id:"door-living",  a:"room-living",  b:"room-hall" },
    { id:"door-throne",  a:"room-toilet",  b:"room-hall" },
  ];
  NAV.doors = {};
  for(const d of doorDefs){
    const el = document.getElementById(d.id);
    if(!el) continue;
    const rr = rectInMapPx(el);
    const pad = 14;
    const rect = {
      left: rr.left - pad,
      top: rr.top - pad,
      right: rr.left + rr.width + pad,
      bottom: rr.top + rr.height + pad
    };
    NAV.doors[d.id] = { a:d.a, b:d.b, rect, cx:(rect.left+rect.right)/2, cy:(rect.top+rect.bottom)/2 };
  }

  NAV.adjacency = {};
  for(const rid of roomIds) NAV.adjacency[rid] = [];
  for(const doorId in NAV.doors){
    const d = NAV.doors[doorId];
    NAV.adjacency[d.a].push({ to:d.b, doorId });
    NAV.adjacency[d.b].push({ to:d.a, doorId });
  }
}

function getRoomAtPoint(x,y){
  // –∫–∞—Ä–º–∞–Ω —Å—á–∏—Ç–∞–µ–º –∫–æ—Ä–∏–¥–æ—Ä–æ–º
  if(NAV.kitchenPassage && rectContains(NAV.kitchenPassage, x, y)) return "room-hall";
  const order = ["room-toilet","room-bath","room-hall","room-bedroom","room-kitchen","room-living"];
  for(const id of order){
    const r = NAV.rooms[id];
    if(r && rectContains(r, x, y)) return id;
  }
  return null;
}

function canTransitionViaDoor(fromRoom, toRoom, x, y){
  for(const id in NAV.doors){
    const d = NAV.doors[id];
    const okPair = (d.a===fromRoom && d.b===toRoom) || (d.a===toRoom && d.b===fromRoom);
    if(!okPair) continue;
    if(rectContains(d.rect, x, y)) return true;
  }
  return false;
}

function canStep(x0,y0, x1,y1){
  const from = getRoomAtPoint(x0,y0);
  const to   = getRoomAtPoint(x1,y1);
  if(!to) return false;
  const fromRoom = from || "room-hall";
  if(to === fromRoom) return true;
  return canTransitionViaDoor(fromRoom, to, x1, y1);
}

/* ===== –¢—É–º–∞–Ω –≤–æ–π–Ω—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∫–∞—Ä–º–∞–Ω –Ω–∞–¥ —Ç—É–∞–ª–µ—Ç–æ–º —Ç–æ–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è) ===== */
const VBW = 900;
const VBH_ROUTE = 520;

function mapPxToSvgXY_FOG(x, y){
  const map = document.getElementById("map");
  const mr = map.getBoundingClientRect();
  return { x: x * (VBW / mr.width), y: y * (VBH_ROUTE / mr.height) };
}

const discoveredRooms = new Set();

function roomRx(roomId){ return (roomId === "room-bath" || roomId === "room-hall") ? 14 : 18; }

function roomRectSvg_FOG(roomId){
  const r = NAV.rooms[roomId];
  if(!r) return null;

  const WALL_PX = 2;
  const a = mapPxToSvgXY_FOG(r.left + WALL_PX,  r.top + WALL_PX);
  const b = mapPxToSvgXY_FOG(r.right - WALL_PX, r.bottom - WALL_PX);

  return { x:a.x, y:a.y, w:(b.x-a.x), h:(b.y-a.y), rx: roomRx(roomId) };
}

// –ù–û–í–û–ï: –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ ‚Äú–∫–∞—Ä–º–∞–Ω–∞‚Äù (–ø—Ä–æ—Ö–æ–¥–∞) –≤ SVG-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
function kitchenPassageRectSvg_FOG(){
  const p = NAV.kitchenPassage;
  if(!p) return null;

  const WALL_PX = 2;
  const a = mapPxToSvgXY_FOG(p.left + WALL_PX,  p.top + WALL_PX);
  const b = mapPxToSvgXY_FOG(p.right - WALL_PX, p.bottom - WALL_PX);

  const w = (b.x - a.x);
  const h = (b.y - a.y);
  if(w < 2 || h < 2) return null;

  return { x:a.x, y:a.y, w, h, rx: 12 };
}

function updateFog(){
  const darkHoles = document.getElementById("fogDarkHoles");
  const lightAreas = document.getElementById("fogLightAreas");
  const currentRect = document.getElementById("fogCurrentRect");
  if(!darkHoles || !lightAreas || !currentRect) return;

  const cur = getRoomAtPoint(playerState.x, playerState.y);
  if(!cur) return;

  discoveredRooms.add(cur);

  const dark = [];

  // –æ—Ç–≤–µ—Ä—Å—Ç–∏—è –¥–ª—è –∫–æ–º–Ω–∞—Ç
  for(const rid of discoveredRooms){
    const rr = roomRectSvg_FOG(rid);
    if(!rr) continue;
    dark.push(`<rect x="${rr.x.toFixed(2)}" y="${rr.y.toFixed(2)}" width="${rr.w.toFixed(2)}" height="${rr.h.toFixed(2)}" rx="${rr.rx}" ry="${rr.rx}" fill="black"></rect>`);
  }

  // –ù–û–í–û–ï: –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∫–æ—Ä–∏–¥–æ—Ä ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏ ‚Äú–∫–∞—Ä–º–∞–Ω‚Äù –Ω–∞–¥ —Ç—É–∞–ª–µ—Ç–æ–º
  if(discoveredRooms.has("room-hall")){
    const pr = kitchenPassageRectSvg_FOG();
    if(pr){
      dark.push(`<rect x="${pr.x.toFixed(2)}" y="${pr.y.toFixed(2)}" width="${pr.w.toFixed(2)}" height="${pr.h.toFixed(2)}" rx="${pr.rx}" ry="${pr.rx}" fill="black"></rect>`);
    }
  }

  darkHoles.innerHTML = dark.join("");
  lightAreas.innerHTML = "";

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
  const rrCur = roomRectSvg_FOG(cur);
  if(rrCur){
    currentRect.setAttribute("x", rrCur.x.toFixed(2));
    currentRect.setAttribute("y", rrCur.y.toFixed(2));
    currentRect.setAttribute("width", rrCur.w.toFixed(2));
    currentRect.setAttribute("height", rrCur.h.toFixed(2));
    currentRect.setAttribute("rx", rrCur.rx);
    currentRect.setAttribute("ry", rrCur.rx);
  }
}

/* ===== –ò–≥—Ä–æ–∫ ===== */
const playerState = { el:null, hint:null, x:0, y:0, moving:false };

function setPlayerPos(x,y){
  playerState.x=x; playerState.y=y;
  playerState.el.style.left = x+"px";
  playerState.el.style.top  = y+"px";
  updateFog();
  checkChestSpawnByProximity();
}

/* ===== —Å—É–Ω–¥—É–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ö–æ–¥–µ ===== */
const CHEST_SPAWN_RADIUS = 120;
function checkChestSpawnByProximity(){
  if(!started) return;
  for(let step=0; step<=3; step++){
    if(i < step) continue;
    const cfg = stepLoot[step];
    const chest = document.getElementById(cfg.chestId);
    if(!chest || chest.classList.contains("show")) continue;

    const c = centerInMapPx(chest);
    const d = Math.hypot(c.x - playerState.x, c.y - playerState.y);
    if(d <= CHEST_SPAWN_RADIUS){
      showChest(step);
      if(i === step) highlight(step);
    }
  }
}

/* collision */
function advanceWithCollision(x0,y0, x1,y1){
  const stepLen = 4;
  const dx = x1-x0, dy = y1-y0;
  const dist = Math.hypot(dx,dy);
  if(dist < 0.001) return { x:x0, y:y0, blocked:false };

  const n = Math.ceil(dist / stepLen);
  let px = x0, py = y0;

  for(let k=1; k<=n; k++){
    const t = k / n;
    const nx = x0 + dx*t;
    const ny = y0 + dy*t;
    if(canStep(px,py, nx,ny)){
      px = nx; py = ny;
    }else{
      return { x:px, y:py, blocked:true };
    }
  }
  return { x:px, y:py, blocked:false };
}

let lastFootstepAt = 0;
let lastFootstepX = 0;
let lastFootstepY = 0;

function movePlayerBumpTo(x,y,onArrive){
  if(playerState.moving) return;

  const map = document.getElementById("map");
  const mr = map.getBoundingClientRect();
  const pad = 14;

  x = clamp(x, pad, mr.width - pad);
  y = clamp(y, pad, mr.height - pad);

  const sx = playerState.x, sy = playerState.y;
  const dx = x - sx, dy = y - sy;
  const dist = Math.hypot(dx,dy);

  const speed = 0.55;
  const duration = clamp(dist / speed, 420, 1400);

  playerState.moving = true;
  playerState.el.classList.add("moving");
  if(playerState.hint) playerState.hint.textContent = "–ò–¥—É‚Ä¶";

  lastFootstepAt = performance.now();
  lastFootstepX = playerState.x;
  lastFootstepY = playerState.y;

  const t0 = performance.now();
  const ease = t => 1 - Math.pow(1 - t, 3);

  function step(now){
    const t = clamp((now - t0)/duration, 0, 1);
    const k = ease(t);

    const desiredX = sx + dx*k;
    const desiredY = sy + dy*k;

    const res = advanceWithCollision(playerState.x, playerState.y, desiredX, desiredY);
    setPlayerPos(res.x, res.y);

    const moved = Math.hypot(playerState.x - lastFootstepX, playerState.y - lastFootstepY);
    const dt = now - lastFootstepAt;
    if(moved >= 22 && dt >= 120){
      playFootstep();
      lastFootstepAt = now;
      lastFootstepX = playerState.x;
      lastFootstepY = playerState.y;
    }

    if(res.blocked){
      playerState.moving = false;
      playerState.el.classList.remove("moving");
      if(playerState.hint) playerState.hint.textContent = "";
      onArrive?.();
      return;
    }

    if(t < 1){
      requestAnimationFrame(step);
    }else{
      playerState.moving = false;
      playerState.el.classList.remove("moving");
      if(playerState.hint) playerState.hint.textContent = "";
      onArrive?.();
    }
  }
  requestAnimationFrame(step);
}

/* smart move */
function findRoomPath(fromRoom, toRoom){
  if(!fromRoom || !toRoom) return null;
  if(fromRoom === toRoom) return [fromRoom];

  const q = [fromRoom];
  const prev = new Map();
  prev.set(fromRoom, null);

  while(q.length){
    const cur = q.shift();
    if(cur === toRoom) break;
    for(const edge of (NAV.adjacency[cur] || [])){
      if(prev.has(edge.to)) continue;
      prev.set(edge.to, { p: cur, doorId: edge.doorId });
      q.push(edge.to);
    }
  }
  if(!prev.has(toRoom)) return null;

  const rooms = [];
  let cur = toRoom;
  while(cur){
    rooms.push(cur);
    const meta = prev.get(cur);
    cur = meta ? meta.p : null;
  }
  rooms.reverse();
  return rooms;
}
function buildWaypointsForPath(rooms, targetX, targetY){
  const pts = [];
  for(let idx=0; idx<rooms.length-1; idx++){
    const a = rooms[idx], b = rooms[idx+1];
    let doorId = null;
    for(const e of (NAV.adjacency[a] || [])){
      if(e.to === b){ doorId = e.doorId; break; }
    }
    if(!doorId) continue;
    const d = NAV.doors[doorId];
    if(d) pts.push({ x: d.cx, y: d.cy });
  }
  pts.push({ x: targetX, y: targetY });
  return pts;
}
function movePlayerSmartTo(targetX, targetY, onArrive){
  const fromRoom = getRoomAtPoint(playerState.x, playerState.y);
  const toRoom   = getRoomAtPoint(targetX, targetY);

  if(!fromRoom || !toRoom || toRoom === fromRoom){
    movePlayerBumpTo(targetX, targetY, onArrive);
    return;
  }
  const roomsPath = findRoomPath(fromRoom, toRoom);
  if(!roomsPath){
    movePlayerBumpTo(targetX, targetY, onArrive);
    return;
  }

  const waypoints = buildWaypointsForPath(roomsPath, targetX, targetY);
  const run = (idx) => {
    if(idx >= waypoints.length){ onArrive?.(); return; }
    const p = waypoints[idx];
    movePlayerBumpTo(p.x, p.y, () => run(idx+1));
  };
  run(0);
}

/* —Å—É–Ω–¥—É–∫–∏ —Ä—è–¥–æ–º */
const chestStepById = (() => {
  const m = new Map();
  stepLoot.forEach((s, idx) => m.set(s.chestId, idx));
  return m;
})();
function findNearestVisibleChest(x,y, radius=78){
  const ids = ["c1","c2","c3","c4"];
  let best=null, bestD=Infinity;
  for(const id of ids){
    const chest = document.getElementById(id);
    if(!chest || !chest.classList.contains("show")) continue;
    const step = chestStepById.get(id);
    const gemId = stepLoot[step]?.gemId;
    if(gemId && collected.has(gemId)) continue;
    const c = centerInMapPx(chest);
    const d = Math.hypot(c.x-x, c.y-y);
    if(d<bestD){ bestD=d; best=chest; }
  }
  return (best && bestD<=radius) ? best : null;
}
function tryAutoOpenTargetChest(chestEl){
  if(!chestEl) return;
  const step = chestStepById.get(chestEl.id);
  if(step === undefined) return;
  const gemId = stepLoot[step]?.gemId;
  if(gemId && collected.has(gemId)) return;
  revealGemFromChest(step);
}

/* inventory */
function gemColorClass(gemEl){
  if(!gemEl) return "";
  if(gemEl.classList.contains("gray")) return "gray";
  if(gemEl.classList.contains("white")) return "white";
  if(gemEl.classList.contains("orange")) return "orange";
  if(gemEl.classList.contains("red")) return "red";
  return "";
}
let confettiDone = false;
function burstConfetti(){
  const layer = document.createElement("div");
  layer.className = "confetti-layer";
  const N = 34;
  for(let k=0;k<N;k++){
    const p = document.createElement("div");
    p.className = "confetti";
    const colors = ["#f2b35c","#d65a4a","#ffffff","#8e8e8e","#c79a38","#e3d0a8"];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.left = (Math.random()*100).toFixed(2) + "vw";
    p.style.width = (7 + Math.random()*7).toFixed(0) + "px";
    p.style.height = (10 + Math.random()*12).toFixed(0) + "px";
    p.style.animationDelay = (Math.random()*80).toFixed(0) + "ms";
    p.style.opacity = (0.75 + Math.random()*0.25).toFixed(2);
    layer.appendChild(p);
  }
  document.body.appendChild(layer);
  setTimeout(() => layer.remove(), 1100);
}

function addToInventory(gemId){
  if(collected.has(gemId)) return;

  const gem = document.getElementById(gemId);
  const slot = document.getElementById("slot-" + gemId);
  if(!gem || !slot) return;

  const color = gemColorClass(gem);
  collected.add(gemId);

  const gr = gem.getBoundingClientRect();
  const sr = slot.getBoundingClientRect();

  const fly = document.createElement("div");
  fly.className = "flying-gem";
  if(color === "gray")   fly.style.background = "linear-gradient(135deg, #bdbdbd, #8e8e8e)";
  if(color === "white")  fly.style.background = "linear-gradient(135deg, #ffffff, #e8e8e8)";
  if(color === "orange") fly.style.background = "linear-gradient(135deg, #f2b35c, #d4842a)";
  if(color === "red")    fly.style.background = "linear-gradient(135deg, #d65a4a, #9f2c24)";

  fly.style.left = (gr.left + gr.width/2 - 17) + "px";
  fly.style.top  = (gr.top  + gr.height/2 - 17) + "px";
  document.body.appendChild(fly);

  const tx = sr.left + sr.width/2 - 17;
  const ty = sr.top  + 18 - 17;

  requestAnimationFrame(() => {
    fly.style.left = tx + "px";
    fly.style.top  = ty + "px";
    fly.style.transform = "rotate(45deg) scale(.65)";
  });

  fly.addEventListener("transitionend", () => {
    fly.style.opacity = "0";
    setTimeout(() => fly.remove(), 120);

    slot.classList.add("filled");
    slot.title = slot.dataset.title || "";
    if(!slot.querySelector(".mini-gem")){
      const mini = document.createElement("div");
      mini.className = "mini-gem " + color;
      slot.appendChild(mini);
    }

    playDing();

    if(!confettiDone && collected.size === 4){
      confettiDone = true;
      burstConfetti();
    }

    updateFinalButtonState();
  }, { once:true });
}

function inventoryPulse(){
  const inv = document.getElementById("inventory");
  if(!inv) return;
  inv.classList.remove("pulse");
  void inv.offsetWidth;
  inv.classList.add("pulse");
}
function updateFinalButtonState(){
  const btn = document.getElementById("nextBtn");
  if(!btn) return;

  finalReady = routeDone && collected.size === 4;

  if(finalReady){
    btn.textContent = "–ù–∞–∂–º–∏";
    btn.style.opacity = "1";
  }else if(routeDone){
    btn.textContent = `–°–æ–±–µ—Ä–∏ –≤—Å–µ –∫–∞–º–Ω–∏ (${collected.size}/4)`;
    btn.style.opacity = "0.95";
  }else{
    btn.textContent = "–°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞";
    btn.style.opacity = "1";
  }
}

/* —Å—É–Ω–¥—É–∫–∏/–∫–∞–º–Ω–∏ */
function showChest(step){
  const cfg = stepLoot[step];
  if(!cfg) return;
  const chest = document.getElementById(cfg.chestId);
  if(!chest) return;
  chest.classList.add("show");
}
function revealGemFromChest(step){
  const cfg = stepLoot[step];
  if(!cfg) return;

  const chest = document.getElementById(cfg.chestId);
  const gem = document.getElementById(cfg.gemId);
  if(!chest || !gem) return;

  if(collected.has(cfg.gemId)) return;

  playChestOpen();

  chest.classList.add("opened");
  gem.classList.add("show");
  addToInventory(cfg.gemId);
}
function bindChestClicks(){
  stepLoot.forEach((cfg, step) => {
    const chest = document.getElementById(cfg.chestId);
    if(!chest) return;
    chest.addEventListener("click", (e) => {
      e.stopPropagation();
      if(!chest.classList.contains("show")) return;
      const c = centerInMapPx(chest);
      movePlayerSmartTo(c.x, c.y, () => tryAutoOpenTargetChest(chest));
    });
  });
}

/* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
function highlight(step){
  stepLoot.forEach(cfg => {
    const chest = document.getElementById(cfg.chestId);
    const gem = document.getElementById(cfg.gemId);
    if(chest){ chest.style.outline="none"; chest.style.outlineOffset="2px"; }
    if(gem){ gem.style.outline="none"; gem.style.outlineOffset="2px"; }
  });
  const bedroom = document.getElementById("room-bedroom");
  if(bedroom){ bedroom.style.outline="none"; bedroom.style.outlineOffset="2px"; }

  if(step >= 0 && step <= 3){
    const cfg = stepLoot[step];
    const chest = document.getElementById(cfg.chestId);
    const gem = document.getElementById(cfg.gemId);
    const target = (chest && chest.classList.contains("show")) ? chest : gem;
    if(target){
      target.style.outline = "4px solid rgba(229,154,58,.55)";
      target.style.outlineOffset = "2px";
    }
    return;
  }
  if(step === 4 && bedroom){
    bedroom.style.outline = "4px solid rgba(229,154,58,.35)";
    bedroom.style.outlineOffset = "2px";
  }
}

/* map clicks */
function bindMapMovement(){
  const map = document.getElementById("map");
  if(!map) return;

  map.addEventListener("click", (e) => {
    ensureAudio();
    if(playerState.moving) return;

    const pt = getMapLocalPoint(e.clientX, e.clientY);

    const nearest = findNearestVisibleChest(pt.x, pt.y, 78);
    if(nearest){
      const c = centerInMapPx(nearest);
      movePlayerSmartTo(c.x, c.y, () => tryAutoOpenTargetChest(nearest));
      return;
    }

    movePlayerSmartTo(pt.x, pt.y);
  });
}

/* ===== –ü–∞–ø–∏—Ä—É—Å ===== */
function showPapyrus(){ document.getElementById("papyrusOverlay")?.classList.add("show"); }
function hidePapyrus(){ document.getElementById("papyrusOverlay")?.classList.remove("show"); }

/* ===== –ö–Ω–æ–ø–∫–∞ / —Ñ–∏–Ω–∞–ª ===== */
function markRouteDone(){ routeDone = true; updateFinalButtonState(); }

function next(){
  ensureAudio();

  if(routeDone && !finalReady){
    inventoryPulse();
    document.getElementById("clue").textContent =
      `–ö–ª–∞–¥ –ø–æ—á—Ç–∏ —Ç–≤–æ–π! –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –∫–∞–º–Ω–∏: ${collected.size}/4.`;
    return;
  }
  if(finalReady){
    showPapyrus();
    return;
  }

  if(!started){
    started = true;
    i = 0;
    document.getElementById("clue").textContent = clues[i];
    highlight(0);
    // –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –±—ã–ª (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω ‚Äî –¥–æ–±–∞–≤–∏—à—å –æ–±—Ä–∞—Ç–Ω–æ)
    checkChestSpawnByProximity();
    return;
  }

  if(i < 3){
    i++;
    document.getElementById("clue").textContent = clues[i];
    highlight(i);
    if(i === 3) markRouteDone();
    checkChestSpawnByProximity();
    return;
  }

  if(i === 3){
    i = 4;
    document.getElementById("clue").textContent = clues[i];
    highlight(4);
  }
}

/* init */
document.addEventListener("DOMContentLoaded", () => {
  bindAudioUnlock();

  playerState.el = document.getElementById("player");
  playerState.hint = document.getElementById("playerHint");

  captureNavGeometry();
  bindChestClicks();
  bindMapMovement();

  // —Å—Ç–∞—Ä—Ç –∏–≥—Ä–æ–∫–∞ –≤ —Å–ø–∞–ª—å–Ω–µ
  const startRoom = document.getElementById("room-bedroom");
  const rr = rectInMapPx(startRoom);
  const startPt = { x: rr.left + rr.width * 0.22, y: rr.top + rr.height * 0.35 };

  discoveredRooms.clear();
  setPlayerPos(startPt.x, startPt.y);

  const overlay = document.getElementById("papyrusOverlay");
  const box = document.getElementById("papyrusBox");
  if(box) box.addEventListener("click", () => hidePapyrus());
  if(overlay) overlay.addEventListener("click", (e) => { if(e.target === overlay) hidePapyrus(); });

  updateFinalButtonState();
});
window.addEventListener("keydown", (e) => { if(e.key === "Escape") hidePapyrus(); });

/* resize */
window.addEventListener("resize", () => {
  captureNavGeometry();
  updateFog();
  checkChestSpawnByProximity();
});
</script>
</body>
</html>
